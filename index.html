<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Padel Pinto - Reserva tu pista</title>
  <script src="https://unpkg.com/mithril/mithril.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="toggleTheme.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/svg+xml" href="src/favicon.svg" />

  <style>
    :root { --padel-green: #2ecc71; --padel-blue: #0f172a; }
    body { font-family: "Plus Jakarta Sans", sans-serif; background-color: #f8fafc; }
    .hero-container { position: relative; height: 380px; width: 100%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #0f172a; }
    .hero-image { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.6; filter: brightness(0.7); }
    .hero-content { position: relative; z-index: 10; text-align: center; color: white; padding: 0 20px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .day-cell { aspect-ratio: 1 / 1; max-width: 48px; margin: 0 auto; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-up { animation: fadeIn 0.6s ease-out forwards; }
    .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e2e8f0; transition: 0.4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.4s; border-radius: 50%; }
    input:checked+.slider { background-color: #2ecc71; }
    input:checked+.slider:before { transform: translateX(20px); }
  </style>
</head>

<body>
  <div id="app"></div>

  <script>
    // --- CONSTANTES ---
    const API_URL = "backend.php";
    const COURT_IMAGES = [
      "https://images.unsplash.com/photo-1554068865-24cecd4e34b8?q=80&w=2070&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1626224583764-f87db24ac4ea?q=80&w=2070&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1599423300746-b62533397364?q=80&w=2070&auto=format&fit=crop",
    ];
    const HOURS = ["09:00", "10:30", "12:00", "13:30", "16:30", "18:00", "19:30", "21:00"];
    const MONTHS = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

    const formatDate = (date) => {
      const d = new Date(date);
      return `${String(d.getDate()).padStart(2, "0")}/${String(d.getMonth() + 1).padStart(2, "0")}/${d.getFullYear()}`;
    };
    const generateInviteCode = () => Math.random().toString(36).substring(2, 8).toUpperCase();

    // --- ESTADO ---
    const State = {
      isLogged: false,
      user: null,
      showUserMenu: false,
      currentView: "booking",
      selectedDate: formatDate(new Date()),
      selectedTime: "10:30",
      viewMonth: new Date().getMonth(),
      viewYear: new Date().getFullYear(),
      inviteInput: "",
      data: {}, courts: [], 
      modal: { show: false, courtId: null, time: "", isPrivate: false, selectedPos: null, occupiedPositions: [], date: "", inviteCode: null, currentMatchId: null },
      confirmModal: { show: false, date: "", matchIndex: -1 },
      toast: { show: false, message: "" },
      heroImage: "https://images.unsplash.com/photo-1626224583764-f87db24ac4ea?q=80&w=2070&auto=format&fit=crop",
    };

    // --- ACCIONES ---
    const Actions = {
      loadData: async () => {
        try {
            // Cargar Pistas
            const pistasRes = await m.request({ url: `${API_URL}?table=pistas` });
            State.courts = (pistasRes.items || []).map(p => ({
                id: p.id, name: p.nombre, type: p.tipo, price: p.precio, img: p.foto_url || COURT_IMAGES[0]
            }));

            // Cargar Partidas y Participantes
            const partidasRes = await m.request({ url: `${API_URL}?table=partidas` });
            const participantesRes = await m.request({ url: `${API_URL}?table=participantes` });
            
            const partidas = partidasRes.items || [];
            const participantes = participantesRes.items || [];

            State.data = {};
            partidas.forEach(partida => {
                // Convertir fecha DB (YYYY-MM-DD) a Frontend (DD/MM/YYYY)
                let fechaFront = partida.fecha;
                if(partida.fecha && partida.fecha.includes("-")) {
                    const parts = partida.fecha.split("-");
                    if(parts.length === 3) fechaFront = `${parts[2]}/${parts[1]}/${parts[0]}`;
                }

                const jugInscritos = participantes.filter(p => p.partida_id == partida.id);
                const matchObj = {
                    dbId: partida.id,
                    courtId: parseInt(partida.pista_id),
                    time: partida.hora,
                    type: partida.tipo_partida || partida.tipo,
                    inviteCode: partida.codigo_invitacion,
                    creatorId: partida.creador_id,
                    players: jugInscritos.map(p => p.nombre_jugador),
                    positions: jugInscritos.map(p => parseInt(p.posicion)),
                    playerIds: jugInscritos.map(p => p.usuario_id)
                };
                if (!State.data[fechaFront]) State.data[fechaFront] = [];
                State.data[fechaFront].push(matchObj);
            });
            m.redraw();
        } catch (e) { console.error("Error cargando datos:", e); }
      },

      checkSession: () => {
        const savedUser = localStorage.getItem("padel_user");
        if (savedUser) {
            try { State.user = JSON.parse(savedUser); State.isLogged = true; } catch(e) {}
        }
        Actions.loadData();
      },

      logout: () => {
        State.isTerminatingSession = true; State.showUserMenu = false; m.redraw();
        setTimeout(() => { localStorage.removeItem("padel_user"); window.location.href = "login.html"; }, 1000);
      },

      changeMonth: (dir) => {
        State.viewMonth += dir;
        if (State.viewMonth < 0) { State.viewMonth = 11; State.viewYear--; }
        else if (State.viewMonth > 11) { State.viewMonth = 0; State.viewYear++; }
        m.redraw();
      },

      showToast: (msg) => {
        State.toast.message = msg; State.toast.show = true; m.redraw();
        setTimeout(() => { State.toast.show = false; m.redraw(); }, 3000);
      },

      openBooking: (courtId, time, date = State.selectedDate) => {
        if (!State.isLogged || !State.user) {
            Actions.showToast("Inicia sesión para reservar");
            setTimeout(() => window.location.href = "login.html", 1500);
            return;
        }

        const match = (State.data[date] || []).find(m => m.courtId === courtId && m.time === time);
        State.modal = {
          show: true,
          courtId, time, date,
          isPrivate: match ? match.type === "private" : false,
          selectedPos: null,
          occupiedPositions: match ? match.positions : [],
          isJoining: !!match,
          currentMatchId: match ? match.dbId : null,
          generatedCode: match ? match.inviteCode : generateInviteCode(),
        };
        m.redraw();
      },

      // --- FUNCIÓN CLAVE CORREGIDA ---
      confirmMatch: async () => {
        console.log("Intentando confirmar reserva...");
        if (State.modal.selectedPos === null) return;
        
        // Verificación de seguridad
        if (!State.user || !State.user.id) {
            alert("Error: Usuario no identificado. Por favor, relogueate.");
            return;
        }

        const userName = State.user.nombre;
        const userId = State.user.id;
        
        // CONVERSIÓN DE FECHA CRÍTICA: DD/MM/YYYY -> YYYY-MM-DD
        const [dia, mes, anio] = State.modal.date.split("/");
        const fechaParaDB = `${anio}-${mes}-${dia}`;

        try {
            if (State.modal.isJoining && State.modal.currentMatchId) {
                // UNIRSE A PARTIDA
                await m.request({
                    method: "POST",
                    url: `${API_URL}?table=participantes`,
                    body: {
                        partida_id: State.modal.currentMatchId,
                        usuario_id: userId,
                        nombre_jugador: userName,
                        posicion: State.modal.selectedPos,
                        equipo: (State.modal.selectedPos < 2) ? 'A' : 'B'
                    }
                });
            } else {
                // CREAR PARTIDA NUEVA
                const nuevaPartida = {
                    pista_id: State.modal.courtId,
                    creador_id: userId,
                    fecha: fechaParaDB, // <--- Aquí usamos la fecha convertida
                    hora: State.modal.time,
                    tipo_partida: State.modal.isPrivate ? "private" : "public",
                    codigo_invitacion: State.modal.isPrivate ? State.modal.generatedCode : null,
                    estado: "abierta"
                };
                
                console.log("Enviando partida:", nuevaPartida);

                const resPartida = await m.request({
                    method: "POST",
                    url: `${API_URL}?table=partidas`,
                    body: nuevaPartida
                });

                if (resPartida.id) {
                    // Crear participante dueño
                    await m.request({
                        method: "POST",
                        url: `${API_URL}?table=participantes`,
                        body: {
                            partida_id: resPartida.id,
                            usuario_id: userId,
                            nombre_jugador: userName,
                            posicion: State.modal.selectedPos,
                            equipo: (State.modal.selectedPos < 2) ? 'A' : 'B',
                            es_propietario: 1
                        }
                    });
                } else {
                    throw new Error("El backend no devolvió ID de partida");
                }
            }
            Actions.showToast("¡Operación realizada con éxito!");
            State.modal.show = false;
            Actions.loadData();

        } catch (e) {
            console.error("Error en confirmMatch:", e);
            alert("Error al guardar: " + e.message);
        }
      },

      joinByCode: () => {
        if (!State.inviteInput) return;
        let found = null;
        Object.keys(State.data).forEach(date => {
          const match = (State.data[date] || []).find(m => m.inviteCode === State.inviteInput.toUpperCase());
          if (match) found = { ...match, date };
        });
        if (found) {
          Actions.openBooking(found.courtId, found.time, found.date);
          State.inviteInput = "";
        } else {
          Actions.showToast("Código no válido");
        }
      },
      
      toggleUserMenu: (e) => { e.stopPropagation(); State.showUserMenu = !State.showUserMenu; },
      scrollToBooking: () => { document.getElementById("booking-section")?.scrollIntoView({ behavior: "smooth" }); }
    };

    // --- COMPONENTES ---
    const Navbar = {
      view: () => m("nav", { class: `border-b sticky top-0 z-50 px-4 transition-colors duration-500 ${ThemeState.darkMode ? "bg-slate-900/80 border-slate-800" : "bg-white/80"} backdrop-blur-md` }, [
          m("div", { class: "max-w-6xl mx-auto flex justify-between items-center h-16" }, [
            m("div", { class: "flex items-center gap-2 cursor-pointer", onclick: () => (State.currentView = "booking") }, [
              m("div", { class: "w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center text-white font-black italic shadow-lg" }, "P"),
              m("span", { class: `font-black text-lg tracking-tighter ${ThemeState.darkMode ? "text-white" : "text-slate-800"}` }, "PADELPINTO"),
            ]),
            m("div", { class: "flex items-center gap-6" }, [
              ["booking", "RESERVAR"], ["matchmaking", "PARTIDAS"], ["agenda", "AGENDA"].map(([view, label]) => 
                  m("button", { class: `text-[10px] font-black tracking-widest ${State.currentView === view ? "text-green-500 border-b-2 border-green-500" : "text-slate-400"} pb-1 hidden md:block`, onclick: () => (State.currentView = view) }, label)
              ),
              m(ThemeToggle),
              State.isLogged && State.user ? m("div", { class: "relative" }, [
                m("div", { class: `w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-bold border-2 border-green-500 cursor-pointer ${ThemeState.darkMode ? "bg-slate-800 text-white" : "bg-slate-100 text-slate-800"}`, onclick: Actions.toggleUserMenu }, State.user.nombre.substring(0,2).toUpperCase()),
                State.showUserMenu && m("div", { class: `absolute right-0 mt-2 w-48 rounded-2xl shadow-xl border py-2 z-[100] ${ThemeState.darkMode ? "bg-slate-800 border-slate-700" : "bg-white border-slate-100"}` }, [
                  m("button", { class: "w-full text-left px-4 py-2 text-xs font-bold text-slate-500 hover:text-green-500", onclick: () => window.location.href = "perfil.html" }, "Mi Perfil"),
                  m("button", { class: "w-full text-left px-4 py-2 text-xs font-bold text-red-500 hover:bg-red-50 transition", onclick: Actions.logout }, "Cerrar sesión"),
                ]),
              ]) : m("div", { class: "flex gap-2" }, [
                  m("button", { class: "text-xs font-bold text-slate-500 hover:text-green-500", onclick: () => window.location.href="login.html" }, "Entrar"),
                  m("button", { class: "text-xs font-bold bg-green-500 text-slate-900 px-3 py-1.5 rounded-lg hover:bg-green-400", onclick: () => window.location.href="registro.html" }, "Cuenta")
              ])
            ]),
          ]),
        ]),
    };

    const Hero = {
      view: () => m("header", { class: "hero-container" }, [
          m("img", { src: State.heroImage, class: "hero-image animate-fade-up" }),
          m("div", { class: "hero-content animate-fade-up" }, [
            m("h1", { class: "text-4xl md:text-6xl font-black mb-4 tracking-tight" }, (State.isLogged && State.user) ? `Hola, ${State.user.nombre.split(" ")[0]}` : "Padel Pinto"),
            m("div", { class: "flex justify-center" }, [
              m("button", { class: "bg-green-500 hover:bg-green-400 px-8 py-4 rounded-2xl font-black text-slate-900 transition shadow-xl", onclick: Actions.scrollToBooking }, "VER PISTAS"),
            ]),
          ]),
        ]),
    };

    const Calendar = {
      view: () => {
        const today = new Date(); today.setHours(0, 0, 0, 0);
        const firstDay = new Date(State.viewYear, State.viewMonth, 1).getDay();
        const daysInMonth = new Date(State.viewYear, State.viewMonth + 1, 0).getDate();
        const blanks = Array(firstDay === 0 ? 6 : firstDay - 1).fill(null);
        const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);

        return m("div", { class: `p-5 rounded-[32px] border shadow-sm mb-6 ${ThemeState.darkMode ? "bg-slate-800 border-slate-700" : "bg-white border-slate-100"}` }, [
          m("div", { class: "flex justify-between items-center mb-5" }, [
            m("h3", { class: `text-base font-black ${ThemeState.darkMode ? "text-white" : "text-slate-800"}` }, `${MONTHS[State.viewMonth]} ${State.viewYear}`),
            m("div", { class: "flex gap-1" }, [
              m("button", { class: "w-8 h-8 flex items-center justify-center rounded-xl bg-slate-100 text-slate-800", onclick: () => Actions.changeMonth(-1) }, "‹"),
              m("button", { class: "w-8 h-8 flex items-center justify-center rounded-xl bg-slate-100 text-slate-800", onclick: () => Actions.changeMonth(1) }, "›")
            ])
          ]),
          m("div", { class: `calendar-grid text-[10px] font-black mb-2 text-center uppercase tracking-tighter text-slate-400` }, ["L", "M", "X", "J", "V", "S", "D"].map((d) => m("div", d))),
          m("div", { class: "calendar-grid" }, [
            ...blanks.map(() => m("div")),
            ...days.map((d) => {
              const currentDate = new Date(State.viewYear, State.viewMonth, d);
              const dateStr = formatDate(currentDate);
              const isSelected = State.selectedDate === dateStr;
              const hasData = State.data[dateStr] && State.data[dateStr].length > 0;
              const isPast = currentDate < today; 
              return m("button", {
                class: `day-cell w-full rounded-2xl flex items-center justify-center text-xs font-bold transition-all relative ${isSelected ? "bg-green-500 text-slate-900 shadow-lg scale-105 z-10" : isPast ? "opacity-40 text-slate-400" : (ThemeState.darkMode ? "hover:bg-slate-700 text-slate-300" : "hover:bg-slate-50 text-slate-600")}`,
                onclick: () => !isPast && (State.selectedDate = dateStr),
                disabled: isPast
              }, [
                m("span", d),
                hasData && m("div", { class: `w-1 h-1 rounded-full absolute bottom-1.5 ${isSelected ? "bg-slate-900" : "bg-green-500"}` })
              ]);
            })
          ])
        ]);
      }
    };

    const CourtGrid = {
      view: () => m("div", { class: "grid grid-cols-1 sm:grid-cols-2 gap-4" },
          State.courts.length === 0 ? m("p", {class:"text-slate-400 text-sm"}, "Cargando pistas...") :
          State.courts.map((c) => {
            const match = (State.data[State.selectedDate] || []).find(m => m.courtId === c.id && m.time === State.selectedTime);
            const playerCount = match ? match.players.length : 0;
            const isFull = playerCount >= 4;
            const userIn = State.isLogged && State.user && match?.playerIds.includes(State.user.id);

            return m("div", { class: `rounded-3xl border overflow-hidden flex shadow-sm hover:shadow-md transition-all group ${ThemeState.darkMode ? "bg-slate-800 border-slate-700" : "bg-white border-slate-100"}` }, [
              m("div", { class: "w-32 bg-cover bg-center", style: `background-image: url(${c.img})` }),
              m("div", { class: "p-4 flex-1 flex flex-col justify-between" }, [
                m("div", [
                  m("h4", { class: `font-black text-xs mb-1 truncate ${ThemeState.darkMode ? "text-white" : "text-slate-800"}` }, c.name),
                  m("div", { class: "flex justify-between items-center mb-3" }, [ m("span", { class: "text-[9px] text-slate-400 font-bold uppercase" }, c.type), m("span", { class: "text-[10px] font-black text-green-600" }, c.price) ]),
                  m("div", { class: `mb-3 ${match ? "block" : "invisible"}` }, [
                     m("div", { class: "flex justify-between text-[8px] font-black mb-1" }, [ m("span", { class: isFull ? "text-slate-400" : "text-amber-500" }, isFull ? "COMPLETO" : "ABIERTO"), m("span", { class: "text-slate-400" }, `${playerCount}/4`) ]),
                     m("div", { class: "w-full h-1 bg-slate-100 rounded-full" }, m("div", { class: "h-full bg-green-500", style: `width:${(playerCount/4)*100}%` }))
                  ])
                ]),
                m("button", {
                  class: `w-full py-2.5 rounded-xl text-[10px] font-black transition ${userIn ? "bg-slate-100 text-slate-400" : isFull ? "bg-slate-50 text-slate-300" : "bg-green-500 text-slate-900"}`,
                  onclick: () => !userIn && !isFull && Actions.openBooking(c.id, State.selectedTime)
                }, userIn ? "INSCRITO" : isFull ? "LLENO" : match ? "UNIRSE" : "RESERVAR")
              ])
            ]);
          })
      )
    };

    const BookingModal = {
      view: () => State.modal.show && m("div", { class: "fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4" }, [
          m("div", { class: `w-full max-w-sm rounded-[40px] overflow-hidden shadow-2xl animate-fade-up ${ThemeState.darkMode ? "bg-slate-800" : "bg-white"}` }, [
            m("div", { class: "bg-slate-900 p-8 text-white" }, [
              m("div", { class: "flex justify-between items-start" }, [
                m("div", [ m("h3", { class: "text-xl font-black" }, State.modal.isJoining ? "Unirse" : "Reservar"), m("p", { class: "text-[10px] text-slate-400 font-bold uppercase mt-1" }, `${State.modal.date} - ${State.modal.time}H`) ]),
                m("button", { onclick: () => State.modal.show = false }, "✕"),
              ]),
            ]),
            m("div", { class: "p-8 text-center" }, [
              m("p", { class: "text-[10px] font-black text-slate-400 uppercase mb-4" }, "Elige tu posición"),
              m("div", { class: "relative w-full aspect-[2/3] max-w-[160px] mx-auto bg-green-600 rounded-xl border-2 border-white/40 shadow-xl mb-8" }, [
                  m("div", { class: "absolute inset-x-0 top-1/2 h-0.5 bg-white/20" }), m("div", { class: "absolute inset-y-0 left-1/2 w-0.5 bg-white/20" }),
                  [{ id: 0, l: "Izq", t: "15%", lf: "12%" }, { id: 1, l: "Izq", t: "70%", lf: "12%" }, { id: 2, l: "Der", t: "15%", lf: "53%" }, { id: 3, l: "Der", t: "70%", lf: "53%" }]
                  .map((p) => {
                    const occ = State.modal.occupiedPositions.includes(p.id);
                    const sel = State.modal.selectedPos === p.id;
                    return m("button", {
                      class: `absolute w-[35%] h-[15%] rounded-xl text-[9px] font-black transition-all ${occ ? "bg-slate-800/50 text-white/20" : sel ? "bg-white text-green-600 scale-110 shadow-lg" : "bg-white/90 text-slate-800 hover:bg-white"}`,
                      style: `top: ${p.t}; left: ${p.lf}`, disabled: occ, onclick: () => (State.modal.selectedPos = p.id),
                    }, occ ? "X" : p.l);
                  }),
              ]),
              m("button", {
                class: `w-full py-4 rounded-2xl text-xs font-black transition-all ${State.modal.selectedPos === null ? "bg-slate-100 text-slate-300" : "bg-green-500 text-slate-900 shadow-xl shadow-green-100 active:scale-95"}`,
                disabled: State.modal.selectedPos === null, onclick: Actions.confirmMatch,
              }, State.modal.isJoining ? "CONFIRMAR UNIÓN" : "CONFIRMAR RESERVA"),
            ]),
          ]),
        ]),
    };

    const MainLayout = {
      view: () => m("div", { class: ThemeActions.getMainClasses() }, [
          m(Navbar), m(Hero),
          m("main", { id: "booking-section", class: "max-w-6xl mx-auto p-4 py-12 flex flex-col md:flex-row gap-8" }, [
            m("aside", { class: "w-full md:w-80 flex-shrink-0" }, [
              m(Calendar),
              m("div", { class: "grid grid-cols-4 gap-2" }, HOURS.map(h => m("button", { class: `py-3 rounded-2xl text-[10px] font-bold border ${State.selectedTime === h ? "bg-green-500 text-slate-900" : "bg-white text-slate-500"}`, onclick: () => State.selectedTime = h }, h)))
            ]),
            m("section", { class: "flex-1" }, [
              m("div", { class: "flex items-center justify-between mb-8" }, [ m("h2", { class: `text-2xl font-black ${ThemeState.darkMode ? "text-white" : "text-slate-800"}` }, "Pistas Disponibles"), m("span", { class: "text-[10px] font-black bg-green-50 text-green-500 px-3 py-1.5 rounded-full" }, `${State.selectedTime}H`) ]),
              m(CourtGrid)
            ])
          ]),
          m(BookingModal),
          m("div", { class: `fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl text-xs font-bold shadow-2xl transition-all z-[200] ${State.toast.show ? "translate-y-0 opacity-100" : "translate-y-24 opacity-0"}` }, State.toast.message),
        ]),
    };

    m.mount(document.getElementById("app"), {
      oninit: Actions.checkSession,
      view: () => m("div", { class: ThemeActions.getMainClasses() }, [ m(MainLayout) ]),
    });
    window.addEventListener("click", () => { if (State.showUserMenu) { State.showUserMenu = false; m.redraw(); } });
  </script>
</body>
</html>