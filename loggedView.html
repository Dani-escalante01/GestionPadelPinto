<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Padel Pinto - Reserva tu pista</title>
  <script src="https://unpkg.com/mithril/mithril.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="toggleTheme.js"></script> <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/svg+xml" href="src/favicon.svg" /> <style>
    :root {
      --padel-green: #2ecc71;
      --padel-blue: #0f172a;
      --padel-accent: #3b82f6;
    }

    body {
      font-family: "Plus Jakarta Sans", sans-serif;
      background-color: #f8fafc;
    }

    .hero-container {
      position: relative;
      height: 380px;
      width: 100%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #0f172a;
    }

    .hero-image {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.6;
      filter: brightness(0.7);
    }

    .hero-content {
      position: relative;
      z-index: 10;
      text-align: center;
      color: white;
      padding: 0 20px;
    }

    ::-webkit-scrollbar {
      height: 6px;
      width: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .day-cell {
      aspect-ratio: 1 / 1;
      max-width: 48px;
      margin: 0 auto;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-up {
      animation: fadeIn 0.6s ease-out forwards;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #e2e8f0;
      transition: 0.4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #2ecc71;
    }

    input:checked+.slider:before {
      transform: translateX(20px);
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <script>
    // --- CONSTANTES ---
    const API_URL = "backend.php";
    
    // Imagenes por defecto por si la DB no tiene foto
    const COURT_IMAGES = [
      "https://images.unsplash.com/photo-1554068865-24cecd4e34b8?q=80&w=2070&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1626224583764-f87db24ac4ea?q=80&w=2070&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1599423300746-b62533397364?q=80&w=2070&auto=format&fit=crop",
    ];
    const HOURS = ["09:00", "10:30", "12:00", "13:30", "16:30", "18:00", "19:30", "21:00",];
    const MONTHS = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre",];

    const formatDate = (date) => {
      const d = new Date(date);
      return `${String(d.getDate()).padStart(2, "0")}/${String(d.getMonth() + 1).padStart(2, "0")}/${d.getFullYear()}`;
    };

    const generateInviteCode = () =>
      Math.random().toString(36).substring(2, 8).toUpperCase();

    // --- ESTADO ---
    const State = {
      isLogged: false,
      user: null, // Se llenarÃ¡ con LocalStorage
      showUserMenu: false,
      currentView: "booking",
      selectedDate: formatDate(new Date()),
      selectedTime: "10:30",
      viewMonth: new Date().getMonth(),
      viewYear: new Date().getFullYear(),
      inviteInput: "",
      
      // Datos dinÃ¡micos (VacÃ­os al inicio)
      data: {}, 
      courts: [], 

      modal: {
        show: false,
        courtId: null,
        time: "",
        isPrivate: false,
        selectedPos: null,
        occupiedPositions: [],
        date: "",
        inviteCode: null,
      },
      confirmModal: { show: false, date: "", matchIndex: -1 },
      toast: { show: false, message: "" },
      heroImage: "https://images.unsplash.com/photo-1626224583764-f87db24ac4ea?q=80&w=2070&auto=format&fit=crop",
    };

    // --- ACCIONES ---
    const Actions = {
      // 1. CARGA DE DATOS: "JOIN" MANUAL EN FRONTEND
      loadData: async () => {
        try {
            // A. Obtener Pistas
            const pistasRes = await m.request({ url: `${API_URL}?table=pistas` });
            State.courts = (pistasRes.items || []).map(p => ({
                id: p.id,
                name: p.nombre,
                type: p.tipo,
                price: p.precio,
                img: p.foto_url || COURT_IMAGES[0]
            }));

            // B. Obtener Partidas y Participantes
            const partidasRes = await m.request({ url: `${API_URL}?table=partidas` });
            const participantesRes = await m.request({ url: `${API_URL}?table=participantes` });
            
            const partidas = partidasRes.items || [];
            const participantes = participantesRes.items || [];

            // C. Procesar y Fusionar (Simular JOIN)
            State.data = {};

            partidas.forEach(partida => {
                const fecha = partida.fecha; // Debe coincidir con formato DD/MM/YYYY

                // Buscamos quiÃ©n juega en esta partida
                const jugInscritos = participantes.filter(p => p.partida_id == partida.id);
                
                // Construimos el objeto Match
                const matchObj = {
                    dbId: partida.id, // ID real de la BD
                    courtId: partida.pista_id,
                    time: partida.hora,
                    type: partida.tipo_partida || partida.tipo, // Ajuste por nombre de columna
                    inviteCode: partida.codigo_invitacion,
                    creatorId: partida.creador_id,
                    // Arrays derivados de participantes
                    players: jugInscritos.map(p => p.nombre_jugador),
                    positions: jugInscritos.map(p => parseInt(p.posicion)),
                    playerIds: jugInscritos.map(p => p.usuario_id)
                };

                // Agrupar por fecha
                if (!State.data[fecha]) State.data[fecha] = [];
                State.data[fecha].push(matchObj);
            });
            m.redraw();

        } catch (e) {
            console.error("Error cargando datos:", e);
            Actions.showToast("Error de conexiÃ³n con base de datos");
        }
      },

      checkSession: () => {
        const savedUser = localStorage.getItem("padel_user");
        if (savedUser) {
            State.user = JSON.parse(savedUser);
            State.isLogged = true;
            
            const params = new URLSearchParams(window.location.search);
            if (params.get("auth") === "success") {
                Actions.showToast("Â¡SesiÃ³n iniciada correctamente!");
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        // Cargamos datos independientemente de si hay login (para ver ocupaciÃ³n)
        Actions.loadData();
      },

      logout: () => {
        State.isTerminatingSession = true;
        State.showUserMenu = false;
        m.redraw();
        setTimeout(() => {
          localStorage.removeItem("padel_user");
          window.location.href = "login.html"; // Redirigir al login
        }, 1200);
      },

      changeMonth: (dir) => {
        State.viewMonth += dir;
        if (State.viewMonth < 0) { State.viewMonth = 11; State.viewYear--; }
        else if (State.viewMonth > 11) { State.viewMonth = 0; State.viewYear++; }
        m.redraw();
      },

      toggleUserMenu: (e) => {
        e.stopPropagation();
        State.showUserMenu = !State.showUserMenu;
      },

      showToast: (msg) => {
        State.toast.message = msg;
        State.toast.show = true;
        m.redraw();
        setTimeout(() => { State.toast.show = false; m.redraw(); }, 3000);
      },

      openBooking: (courtId, time, date = State.selectedDate) => {
        if (!State.isLogged) {
            Actions.showToast("Inicia sesiÃ³n para reservar");
            setTimeout(() => window.location.href="login.html", 1500);
            return;
        }

        const match = (State.data[date] || []).find(m => m.courtId === courtId && m.time === time);
        State.modal = {
          show: true,
          courtId, time, date,
          isPrivate: match ? match.type === "private" : false,
          selectedPos: null,
          occupiedPositions: match ? match.positions : [],
          isJoining: !!match,
          currentMatchId: match ? match.dbId : null, // ID para unirse
          generatedCode: match ? match.inviteCode : generateInviteCode(),
        };
      },

      // --- CREAR / UNIRSE A RESERVA ---
      confirmMatch: async () => {
        if (State.modal.selectedPos === null) return;
        
        const userName = State.user.nombre;
        const userId = State.user.id;

        // CASO 1: UNIRSE A PARTIDA EXISTENTE
        if (State.modal.isJoining && State.modal.currentMatchId) {
            try {
                // Insertar participante
                await m.request({
                    method: "POST",
                    url: `${API_URL}?table=participantes`,
                    body: {
                        partida_id: State.modal.currentMatchId,
                        usuario_id: userId,
                        nombre_jugador: userName,
                        posicion: State.modal.selectedPos,
                        equipo: (State.modal.selectedPos < 2) ? 'A' : 'B' // LÃ³gica simple equipos
                    }
                });
                Actions.showToast("Â¡Te has unido al partido!");
                State.modal.show = false;
                Actions.loadData(); // Recargar todo

            } catch (e) {
                console.error(e);
                Actions.showToast("Error al unirse.");
            }
            return;
        }

        // CASO 2: CREAR NUEVA RESERVA
        try {
            // 1. Crear Partida
            const nuevaPartida = {
                pista_id: State.modal.courtId,
                creador_id: userId,
                fecha: State.modal.date,
                hora: State.modal.time,
                tipo_partida: State.modal.isPrivate ? "private" : "public",
                codigo_invitacion: State.modal.isPrivate ? State.modal.generatedCode : null,
                estado: "abierta"
            };

            const resPartida = await m.request({
                method: "POST",
                url: `${API_URL}?table=partidas`,
                body: nuevaPartida
            });

            if (resPartida.id) {
                // 2. Insertar al Creador como Participante
                await m.request({
                    method: "POST",
                    url: `${API_URL}?table=participantes`,
                    body: {
                        partida_id: resPartida.id,
                        usuario_id: userId,
                        nombre_jugador: userName,
                        posicion: State.modal.selectedPos,
                        equipo: (State.modal.selectedPos < 2) ? 'A' : 'B',
                        es_propietario: 1
                    }
                });

                Actions.showToast("Â¡Reserva Creada con Ã‰xito!");
                State.modal.show = false;
                Actions.loadData(); // Recargar datos
            }

        } catch (e) {
            console.error(e);
            Actions.showToast("Error al reservar pista.");
        }
      },

      joinByCode: () => {
        if (!State.inviteInput) return;
        let found = null;
        Object.keys(State.data).forEach(date => {
          const match = (State.data[date] || []).find(m => m.inviteCode === State.inviteInput.toUpperCase());
          if (match) found = { ...match, date };
        });

        if (found) {
          if (found.players.length >= 4) return Actions.showToast("La partida ya estÃ¡ completa");
          if (found.players.includes(State.user.nombre)) return Actions.showToast("Ya estÃ¡s en esta partida");
          Actions.openBooking(found.courtId, found.time, found.date);
          State.inviteInput = "";
        } else {
          Actions.showToast("CÃ³digo no vÃ¡lido");
        }
      },

      cancelBooking: (date, matchIndex) => {
        // Para simplificar en esta versiÃ³n, solo mostramos el toast
        // Implementar borrado real requerirÃ­a DELETE en backend.php
        Actions.showToast("FunciÃ³n de cancelar pendiente de implementar en backend");
        State.confirmModal.show = false;
      },

      scrollToBooking: () => {
        document.getElementById("booking-section")?.scrollIntoView({ behavior: "smooth" });
      }
    };

    // --- COMPONENTES ---

    const Navbar = {
      view: () =>
        m("nav", {
          class: `border-b sticky top-0 z-50 px-4 transition-colors duration-500 ${ThemeState.darkMode ? "bg-slate-900/80 border-slate-800" : "bg-white/80"} backdrop-blur-md`
        }, [
          m("div", { class: "max-w-6xl mx-auto flex justify-between items-center h-16" }, [
            m("div", {
              class: "flex items-center gap-2 cursor-pointer",
              onclick: () => (State.currentView = "booking")
            }, [
              m("div", { class: "w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center text-white font-black italic shadow-lg shadow-green-200" }, "P"),
              m("span", { class: `font-black text-lg tracking-tighter ${ThemeState.darkMode ? "text-white" : "text-slate-800"}` }, "PADELPINTO"),
            ]),

            m("div", { class: "flex items-center gap-6" }, [
              // Botones de navegaciÃ³n
              ["booking", "RESERVAR"], ["matchmaking", "PARTIDAS ABIERTAS"], ["agenda", "MI AGENDA"].map(([view, label]) => 
                  m("button", {
                    class: `text-[10px] font-black tracking-widest ${State.currentView === view ? "text-green-500 border-b-2 border-green-500" : "text-slate-400"} pb-1`,
                    onclick: () => (State.currentView = view),
                  }, label)
              ),
              
              m(ThemeToggle),

              // LÃ³gica de Usuario Logueado / No Logueado
              State.isLogged ? m("div", { class: "relative" }, [
                m("div", {
                  class: `w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-bold border-2 border-green-500 cursor-pointer hover:scale-105 transition-transform ${ThemeState.darkMode ? "bg-slate-800 text-white" : "bg-slate-100 text-slate-800"}`,
                  onclick: Actions.toggleUserMenu,
                }, State.user.nombre.substring(0,2).toUpperCase()),

                State.showUserMenu && m("div", {
                  class: `absolute right-0 mt-2 w-48 rounded-2xl shadow-xl border py-2 z-[100] animate-fade-up ${ThemeState.darkMode ? "bg-slate-800 border-slate-700" : "bg-white border-slate-100"}`,
                }, [
                  m("div", { class: `px-4 py-2 border-b mb-1 ${ThemeState.darkMode ? "border-slate-700" : "border-slate-50"}` }, [
                    m("p", { class: "text-[10px] font-black text-slate-400 uppercase" }, "Usuario"),
                    m("p", { class: `text-xs font-bold ${ThemeState.darkMode ? "text-white" : "text-slate-800"}` }, State.user.nombre),
                  ]),
                  m("button", {
                    class: `w-full text-left px-4 py-2 text-xs font-bold transition ${ThemeState.darkMode ? "text-slate-300 hover:bg-slate-700 hover:text-green-400" : "text-slate-600 hover:bg-slate-50 hover:text-green-500"}`,
                    onclick: () => window.location.href = "perfil.html",
                  }, "Mi Perfil"),
                  m("hr", { class: `my-1 ${ThemeState.darkMode ? "border-slate-700" : "border-slate-50"}` }),
                  m("button", {
                    class: "w-full text-left px-4 py-2 text-xs font-bold text-red-500 hover:bg-red-50 transition",
                    onclick: Actions.logout,
                  }, "Cerrar sesiÃ³n"),
                ]),
              ]) : 
              // Botones si NO estÃ¡ logueado
              m("div", { class: "flex gap-2" }, [
                  m("button", { class: "text-xs font-bold text-slate-500 hover:text-green-500", onclick: () => window.location.href="login.html" }, "Entrar"),
                  m("button", { class: "text-xs font-bold bg-green-500 text-slate-900 px-3 py-1.5 rounded-lg hover:bg-green-400", onclick: () => window.location.href="registro.html" }, "Crear Cuenta")
              ])
            ]),
          ]),
        ]),
    };

    const Hero = {
      view: () =>
        m("header", { class: "hero-container" }, [
          m("img", { src: State.heroImage, class: "hero-image animate-fade-up" }),
          m("div", { class: "hero-content animate-fade-up" }, [
            m("span", { class: "inline-block px-3 py-1 bg-green-500 text-slate-900 text-[10px] font-black rounded-full mb-4" }, "ZONA JUGADORES"),
            m("h1", { class: "text-4xl md:text-6xl font-black mb-4 tracking-tight" }, 
                State.isLogged ? "Hola, " + State.user.nombre.split(" ")[0] : "Bienvenido a PadelPinto"
            ),
            m("p", { class: "text-slate-200 text-sm md:text-lg max-w-xl mx-auto font-medium mb-8" }, "Gestiona tus reservas y Ãºnete a los prÃ³ximos partidos en tu club."),
            m("div", { class: "flex flex-col sm:flex-row justify-center gap-4" }, [
              m("button", { class: "bg-green-500 hover:bg-green-400 px-8 py-4 rounded-2xl font-black text-slate-900 transition shadow-xl transform hover:scale-105", onclick: Actions.scrollToBooking }, "VER PISTAS"),
            ]),
          ]),
        ]),
    };

    const Calendar = {
      view: () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const firstDay = new Date(State.viewYear, State.viewMonth, 1).getDay();
        const daysInMonth = new Date(State.viewYear, State.viewMonth + 1, 0).getDate();
        const blanks = Array(firstDay === 0 ? 6 : firstDay - 1).fill(null);
        const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);

        return m("div", {
          class: `p-5 rounded-[32px] border shadow-sm mb-6 transition-colors duration-500 ${ThemeState.darkMode ? "bg-slate-800 border-slate-700" : "bg-white border-slate-100"}`
        }, [
          m("div", { class: "flex justify-between items-center mb-5" }, [
            m("div", [
              m("p", { class: "text-[9px] font-black text-green-500 uppercase tracking-widest mb-0.5" }, "Calendario"),
              m("h3", { class: `text-base font-black ${ThemeState.darkMode ? "text-white" : "text-slate-800"}` }, `${MONTHS[State.viewMonth]} ${State.viewYear}`)
            ]),
            m("div", { class: "flex gap-1" }, [
              m("button", {
                class: `w-8 h-8 flex items-center justify-center rounded-xl transition ${ThemeState.darkMode ? "hover:bg-slate-700 text-white" : "hover:bg-slate-50 text-slate-800"}`,
                onclick: () => Actions.changeMonth(-1)
              }, "â€¹"),
              m("button", {
                class: `w-8 h-8 flex items-center justify-center rounded-xl transition ${ThemeState.darkMode ? "hover:bg-slate-700 text-white" : "hover:bg-slate-50 text-slate-800"}`,
                onclick: () => Actions.changeMonth(1)
              }, "â€º")
            ])
          ]),
          m("div", { class: `calendar-grid text-[10px] font-black mb-2 text-center uppercase tracking-tighter ${ThemeState.darkMode ? "text-slate-400" : "text-slate-500"}` },
            ["L", "M", "X", "J", "V", "S", "D"].map((d) => m("div", d))
          ),
          m("div", { class: "calendar-grid" }, [
            ...blanks.map(() => m("div")),
            ...days.map((d) => {
              const currentDate = new Date(State.viewYear, State.viewMonth, d);
              const dateStr = formatDate(currentDate);

              const isSelected = State.selectedDate === dateStr;
              const hasData = State.data[dateStr] && State.data[dateStr].length > 0;
              const isPast = currentDate < today; 

              return m("button", {
                class: `day-cell w-full rounded-2xl flex items-center justify-center text-xs font-bold transition-all relative ${isSelected
                  ? "bg-green-500 text-slate-900 shadow-lg scale-105 z-10"
                  : isPast
                    ? (ThemeState.darkMode ? "opacity-60 text-slate-600 cursor-default" : "opacity-60 text-slate-400 cursor-default")
                    : (ThemeState.darkMode ? "hover:bg-slate-700 text-slate-300" : "hover:bg-slate-50 text-slate-600")
                  }`,
                onclick: () => !isPast && (State.selectedDate = dateStr),
                disabled: isPast
              }, [
                m("span", d),
                hasData && m("div", { class: `w-1 h-1 rounded-full absolute bottom-1.5 ${isSelected ? "bg-slate-900" : "bg-green-500"} ${isPast ? "opacity-30" : ""}` })
              ]);
            })
          ])
        ]);
      }
    };

    const CourtGrid = {
      view: () =>
        m("div", { class: "grid grid-cols-1 sm:grid-cols-2 gap-4" },
          State.courts.length === 0 ? m("p", "Cargando pistas...") :
          State.courts.map((c) => {
            const match = (State.data[State.selectedDate] || []).find(
              (m) => m.courtId === c.id && m.time === State.selectedTime
            );

            const playerCount = match ? match.players.length : 0;
            const isFull = playerCount >= 4;
            // Comprobamos si el usuario actual ya estÃ¡ en la partida
            const userIn = State.isLogged && match?.playerIds.includes(State.user.id);
            const label = isFull ? "CERRADO" : match?.type === "private" ? "PRIVADO" : "ABIERTO";

            const progressPercentage = (playerCount / 4) * 100;

            return m("div", {
              class: `rounded-3xl border overflow-hidden flex shadow-sm hover:shadow-md transition-all group ${ThemeState.darkMode ? "bg-slate-800 border-slate-700" : "bg-white border-slate-100"}`
            }, [
              m("div", {
                class: "w-32 bg-cover bg-center",
                style: `background-image: url(${c.img})`
              }),
              m("div", { class: "p-4 flex-1 flex flex-col justify-between" }, [
                m("div", [
                  m("h4", { class: `font-black text-xs mb-1 truncate ${ThemeState.darkMode ? "text-white" : "text-slate-800"}` }, c.name),
                  m("div", { class: "flex justify-between items-center mb-3" }, [
                    m("span", { class: "text-[9px] text-slate-400 font-bold uppercase" }, c.type),
                    m("span", { class: "text-[10px] font-black text-green-600" }, c.price)
                  ]),

                  m("div", { class: `mb-3 ${match ? "block" : "invisible"}` }, [
                    m("div", { class: "flex justify-between text-[8px] font-black mb-1" }, [
                      m("span", { class: isFull ? "text-slate-400" : match?.type === "private" ? "text-red-400" : "text-amber-500" }, label),
                      m("span", { class: "text-slate-400" }, `${playerCount}/4`)
                    ]),
                    m("div", { class: `w-full h-1.5 rounded-full overflow-hidden ${ThemeState.darkMode ? "bg-slate-700" : "bg-slate-100"}` },
                      m("div", {
                        class: `h-full transition-all duration-500 ease-out ${isFull ? "bg-slate-400" : "bg-green-500"}`,
                        style: `width: ${progressPercentage}%`
                      })
                    )
                  ]),
                ]),

                m("button", {
                  class: `w-full py-2.5 rounded-xl text-[10px] font-black transition ${userIn
                    ? (ThemeState.darkMode ? "bg-slate-700 text-slate-500" : "bg-slate-100 text-slate-400")
                    : isFull
                      ? (ThemeState.darkMode ? "bg-slate-900 text-slate-600" : "bg-slate-50 text-slate-300")
                      : match
                        ? (ThemeState.darkMode ? "bg-white text-slate-900" : "bg-slate-900 text-white shadow-lg")
                        : "bg-green-500 text-slate-900"
                    }`,
                  onclick: () => !userIn && !isFull && Actions.openBooking(c.id, State.selectedTime)
                }, userIn ? "INSCRITO" : isFull ? "LLENO" : match ? "UNIRSE" : "RESERVAR")
              ])
            ]);
          })
        )
    };

    const MatchmakingView = {
      view: () => {
        const openMatches = [];
        Object.keys(State.data).forEach((date) => {
          State.data[date].forEach((m) => {
            if (m.type === "public") openMatches.push({ ...m, date });
          });
        });

        return m("div", { class: "flex-1 animate-fade-up" }, [
          m("h2", {
            class: `text-2xl font-black mb-6 ${ThemeState.darkMode ? "text-white" : "text-slate-800"}`
          }, "Partidas Abiertas"),

          openMatches.length === 0
            ? m("div", {
              class: `py-20 text-center rounded-3xl ${ThemeState.darkMode ? "bg-slate-800 text-slate-400" : "bg-white text-slate-500"}`
            }, "No hay partidas buscando jugadores.")
            : m("div", { class: "grid gap-4" }, openMatches.map((match) => {
              const court = State.courts.find((c) => c.id === match.courtId);
              const isFull = match.players.length >= 4;
              const courtName = court ? court.name : "Pista " + match.courtId;

              return m("div", {
                class: `p-5 rounded-3xl shadow-sm flex items-center justify-between border transition-colors duration-300 ${ThemeState.darkMode
                  ? "bg-slate-800 border-slate-700"
                  : "bg-white border-slate-50"
                  }`
              }, [
                m("div", { class: "flex gap-4 items-center" }, [
                  m("div", {
                    class: `w-12 h-12 rounded-2xl flex flex-col items-center justify-center font-black ${ThemeState.darkMode ? "bg-slate-900 text-white" : "bg-slate-50 text-slate-800"
                      }`
                  }, [
                    m("span", { class: "text-[10px] text-slate-400" }, match.date.split("/")[1]),
                    m("span", { class: "text-sm" }, match.date.split("/")[0]),
                  ]),
                  m("div", [
                    m("p", {
                      class: `text-xs font-black ${ThemeState.darkMode ? "text-white" : "text-slate-800"}`
                    }, `${match.time}H - ${courtName}`),
                    m("p", { class: "text-[10px] font-bold text-slate-400" },
                      isFull ? "PARTIDA CERRADA" : `${match.players.length}/4 jugadores inscritos`
                    ),
                  ]),
                ]),
                m("button", {
                  class: `px-6 py-2 rounded-xl text-[10px] font-black transition-all ${isFull
                    ? (ThemeState.darkMode ? "bg-slate-700 text-slate-500" : "bg-slate-100 text-slate-400")
                    : (ThemeState.darkMode
                      ? "bg-green-500 text-slate-900 hover:bg-green-400"
                      : "bg-green-500 text-slate-900 shadow-lg shadow-green-100")
                    }`,
                  disabled: isFull,
                  onclick: () => Actions.openBooking(match.courtId, match.time, match.date),
                }, isFull ? "CERRADO" : "UNIRSE"),
              ]);
            })),
        ]);
      },
    };

    const AgendaView = {
      view: () => {
        if (!State.isLogged) return m("div", {class:"p-10 text-center"}, "Inicia sesiÃ³n para ver tu agenda");

        const myMatches = [];
        Object.keys(State.data).forEach((date) => {
          State.data[date].forEach((m, idx) => {
            // Buscamos por ID de usuario
            if (m.playerIds.includes(State.user.id))
              myMatches.push({ ...m, date });
          });
        });

        return m("div", { class: "flex-1 animate-fade-up" }, [
          m("h2", {
            class: `text-2xl font-black mb-6 ${ThemeState.darkMode ? "text-white" : "text-slate-800"}`
          }, "Mi Agenda"),

          myMatches.length === 0
            ? m("div", {
              class: `py-20 text-center rounded-3xl ${ThemeState.darkMode ? "bg-slate-800 text-slate-400" : "bg-white text-slate-500"}`
            }, "No tienes reservas prÃ³ximamente.")
            : m("div", { class: "grid gap-4" },
              myMatches.map((match) => {
                const court = State.courts.find((c) => c.id === match.courtId);
                const courtName = court ? court.name : "Pista " + match.courtId;
                
                return m("div", {
                  class: `p-5 rounded-3xl shadow-sm border-l-4 border-green-500 flex justify-between items-center hover:shadow-md transition-all ${ThemeState.darkMode ? "bg-slate-800 border-y border-r border-slate-700" : "bg-white border-l-4"
                    }`
                }, [
                  m("div", [
                    m("div", { class: "flex items-center gap-2 mb-1" }, [
                      m("p", {
                        class: `text-xs font-black ${ThemeState.darkMode ? "text-white" : "text-slate-900"}`
                      }, `${match.date} - ${match.time}H`),

                      match.inviteCode && m("span", {
                        class: `text-[8px] px-1.5 py-0.5 rounded font-black tracking-widest ${ThemeState.darkMode ? "bg-slate-700 text-slate-400" : "bg-slate-100 text-slate-500"
                          }`
                      }, `ID: ${match.inviteCode}`),
                    ]),
                    m("p", { class: "text-[10px] font-bold text-slate-400 uppercase" }, courtName),
                  ]),

                  m("button", {
                    class: `px-4 py-2 rounded-xl text-[10px] font-black transition-all ${ThemeState.darkMode
                      ? "bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white"
                      : "bg-red-50 text-red-500 hover:bg-red-500 hover:text-white"
                      }`,
                    onclick: () => {
                      State.confirmModal = { show: true, date: match.date };
                    },
                  }, "CANCELAR"),
                ]);
              }),
            ),
        ]);
      },
    };

    const BookingModal = {
      view: () =>
        State.modal.show &&
        m("div", { class: "fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4" }, [
          m("div", {
            class: `w-full max-w-sm rounded-[40px] overflow-hidden shadow-2xl animate-fade-up transition-colors duration-500 ${ThemeState.darkMode ? "bg-slate-800" : "bg-white"}`
          }, [
            m("div", { class: "bg-slate-900 p-8 text-white" }, [
              m("div", { class: "flex justify-between items-start" }, [
                m("div", [
                  m("h3", { class: "text-xl font-black tracking-tight" }, State.modal.isJoining ? "Ãšnete a la Partida" : "Configura tu Reserva"),
                  m("p", { class: "text-[10px] text-slate-400 font-bold uppercase mt-1" }, `${State.modal.date} - ${State.modal.time}H`),
                ]),
                m("button", {
                  class: "text-slate-400 hover:text-white transition",
                  onclick: () => { State.modal.show = false; State.modal.tempCode = ""; }
                }, "âœ•"),
              ]),
            ]),

            m("div", { class: "p-8 text-center" }, [
              State.modal.isJoining && State.modal.isPrivate && State.modal.tempCode !== State.modal.generatedCode ? [
                m("div", { class: "mb-6" }, [
                  m("div", { class: "w-12 h-12 bg-amber-500/10 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-4" }, "ðŸ”’"),
                  m("h4", { class: `text-sm font-black mb-1 ${ThemeState.darkMode ? "text-white" : "text-slate-800"}` }, "Partida Privada"),
                  m("p", { class: "text-[10px] text-slate-400 font-bold uppercase mb-4" }, "Introduce el cÃ³digo para desbloquear"),
                  m("input", {
                    type: "text",
                    class: `w-full p-4 rounded-2xl border-2 text-center text-lg font-black tracking-widest focus:outline-none transition ${ThemeState.darkMode ? "bg-slate-900 border-slate-700 text-white focus:border-green-500" : "bg-slate-50 border-slate-200 text-slate-800 focus:border-green-500"
                      }`,
                    placeholder: "CÃ“DIGO",
                    value: State.modal.tempCode || "",
                    oninput: (e) => (State.modal.tempCode = e.target.value.toUpperCase()),
                  }),
                  State.modal.tempCode?.length > 0 && State.modal.tempCode !== State.modal.generatedCode &&
                  m("p", { class: "text-[9px] text-red-500 font-bold mt-2 animate-pulse" }, "CÃ“DIGO INCORRECTO")
                ])
              ] : [
                !State.modal.isJoining && m("div", {
                  class: `flex items-center justify-between mb-6 p-4 rounded-2xl border transition-colors ${ThemeState.darkMode ? "bg-slate-900 border-slate-700" : "bg-slate-50 border-slate-100"}`
                }, [
                  m("div", { class: "text-left" }, [
                    m("p", { class: `text-xs font-black ${ThemeState.darkMode ? "text-white" : "text-slate-800"}` }, "Partida Privada"),
                    m("p", { class: "text-[9px] text-slate-400 font-bold" }, "Solo con cÃ³digo de invitaciÃ³n"),
                  ]),
                  m("label", { class: "toggle-switch" }, [
                    m("input", { type: "checkbox", checked: State.modal.isPrivate, onchange: (e) => (State.modal.isPrivate = e.target.checked) }),
                    m("span", { class: "slider" }),
                  ]),
                ]),

                State.modal.isPrivate && m("div", {
                  class: `mb-6 p-3 rounded-2xl border border-dashed transition-colors ${ThemeState.darkMode ? "bg-green-900/20 border-green-800" : "bg-green-50 border-green-200"}`
                }, [
                  m("p", { class: "text-[9px] font-black text-green-600 uppercase mb-1" }, State.modal.isJoining ? "âœ“ Acceso Concedido" : "CÃ³digo de InvitaciÃ³n"),
                  m("p", { class: `text-lg font-black tracking-widest ${ThemeState.darkMode ? "text-green-400" : "text-slate-800"}` }, State.modal.generatedCode),
                ]),

                m("p", { class: "text-[10px] font-black text-slate-400 uppercase mb-4" }, "Elige tu posiciÃ³n"),

                m("div", { class: "relative w-full aspect-[2/3] max-w-[160px] mx-auto bg-green-600 rounded-xl border-2 border-white/40 shadow-xl mb-8" }, [
                  m("div", { class: "absolute inset-x-0 top-1/2 h-0.5 bg-white/20" }),
                  m("div", { class: "absolute inset-y-0 left-1/2 w-0.5 bg-white/20" }),
                  [
                    { id: 0, l: "Izq", t: "15%", lf: "12%" },
                    { id: 1, l: "Izq", t: "70%", lf: "12%" },
                    { id: 2, l: "Der", t: "15%", lf: "53%" },
                    { id: 3, l: "Der", t: "70%", lf: "53%" },
                  ].map((p) => {
                    const occ = State.modal.occupiedPositions.includes(p.id);
                    const sel = State.modal.selectedPos === p.id;
                    return m("button", {
                      class: `absolute w-[35%] h-[15%] rounded-xl text-[9px] font-black transition-all ${occ ? "bg-slate-800/50 text-white/20" : sel ? "bg-white text-green-600 scale-110 shadow-lg" : "bg-white/90 text-slate-800 hover:bg-white"}`,
                      style: `top: ${p.t}; left: ${p.lf}`,
                      disabled: occ,
                      onclick: () => (State.modal.selectedPos = p.id),
                    }, occ ? "X" : p.l);
                  }),
                ]),

                m("button", {
                  class: `w-full py-4 rounded-2xl text-xs font-black transition-all ${State.modal.selectedPos === null
                    ? (ThemeState.darkMode ? "bg-slate-700 text-slate-500" : "bg-slate-100 text-slate-300")
                    : "bg-green-50 text-slate-900 shadow-xl shadow-green-100 active:scale-95"
                    }`,
                  disabled: State.modal.selectedPos === null,
                  onclick: () => {
                    Actions.confirmMatch();
                  },
                }, State.modal.isJoining ? "UNIRSE AL PARTIDO" : "CONFIRMAR RESERVA"),
              ]
            ]),
          ]),
        ]),
    };

    const ConfirmModal = {
      view: () =>
        State.confirmModal.show &&
        m("div", { class: "fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[150] flex items-center justify-center p-4" }, [
          m("div", {
            class: `w-full max-w-xs rounded-[32px] p-6 text-center animate-fade-up shadow-2xl transition-colors duration-500 ${ThemeState.darkMode ? "bg-slate-800" : "bg-white"
              }`
          }, [
            m("div", {
              class: `w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4 ${ThemeState.darkMode ? "bg-red-900/30 text-red-400" : "bg-red-50 text-red-500"
                }`
            }, "!"),
            m("h3", { class: `text-lg font-black mb-2 ${ThemeState.darkMode ? "text-white" : "text-slate-800"}` }, "Â¿Cancelar reserva?"),
            m("p", { class: "text-xs text-slate-400 font-medium mb-6" }, "Esta acciÃ³n eliminarÃ¡ tu plaza en la pista. Â¿EstÃ¡s seguro?"),
            m("div", { class: "flex gap-3" }, [
              m("button", {
                class: `flex-1 py-3 rounded-xl text-xs font-black transition ${ThemeState.darkMode ? "bg-slate-700 text-slate-300 hover:bg-slate-600" : "bg-slate-100 text-slate-600 hover:bg-slate-200"
                  }`,
                onclick: () => (State.confirmModal.show = false),
              }, "VOLVER"),
              m("button", {
                class: "flex-1 py-3 rounded-xl bg-red-500 text-white text-xs font-black hover:bg-red-600 transition shadow-lg shadow-red-500/20",
                onclick: () => Actions.cancelBooking(State.confirmModal.date, State.confirmModal.matchIndex),
              }, "SÃ, CANCELAR"),
            ]),
          ]),
        ]),
    };

    const Footer = {
      view: () =>
        m("footer", {
          class: `transition-colors duration-500 mt-20 pt-16 pb-8 px-4 border-t ${ThemeState.darkMode
            ? "bg-slate-950 text-white border-slate-800"
            : "bg-slate-900 text-white border-transparent"
            }`
        }, [
          m("div", { class: "max-w-6xl mx-auto" }, [
            m("div", { class: "grid grid-cols-1 md:grid-cols-3 gap-12 mb-12" }, [
              m("div", [
                m("div", { class: "flex items-center gap-2 mb-6" }, [
                  m("div", { class: "w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center text-white font-black italic text-sm shadow-lg shadow-green-500/20" }, "P"),
                  m("span", { class: "font-extrabold text-xl tracking-tighter" }, "PADELPINTO "),
                ]),
                m("p", { class: "text-slate-400 text-sm leading-relaxed" }, "La plataforma lÃ­der para la gestiÃ³n de pistas y comunidades de pÃ¡del."),
              ]),

              m("div", [
                m("h4", { class: "font-bold mb-6 text-green-500 uppercase text-xs tracking-widest" }, "NavegaciÃ³n"),
                m("ul", { class: "space-y-4 text-sm text-slate-300" }, [
                  m("li", { class: "hover:text-white cursor-pointer transition" }, "Centro de Ayuda"),
                  m("li", { class: "hover:text-white cursor-pointer transition" }, "Normas del Club"),
                ]),
              ]),

              m("div", [
                m("h4", { class: "font-bold mb-6 text-green-500 uppercase text-xs tracking-widest" }, "Mantente al dÃ­a"),
                m("div", { class: "flex gap-2 mb-6" }, [
                  m("input[type=text]", {
                    class: `border-none rounded-lg px-4 py-2 text-sm w-full focus:ring-2 focus:ring-green-500 transition-colors ${ThemeState.darkMode ? "bg-slate-900 text-white" : "bg-slate-800 text-white"
                      }`,
                    placeholder: "Tu email",
                  }),
                  m("button", { class: "bg-green-500 text-slate-900 px-4 py-2 rounded-lg font-bold text-sm hover:bg-green-400 transition" }, "OK"),
                ]),
              ]),
            ]),

            m("div", {
              class: `border-t pt-8 flex flex-col md:flex-row justify-between items-center gap-4 text-[10px] font-bold uppercase tracking-widest transition-colors ${ThemeState.darkMode ? "border-slate-800 text-slate-600" : "border-slate-800 text-slate-500"
                }`
            }, [
              m("span", "Â© 2026 Padel Pro International."),
            ]),
          ]),
        ]),
    };

    const MainLayout = {
      view: () =>
        m("div", { class: ThemeActions.getMainClasses() }, [
          m(Navbar),
          m(Hero),
          m("main", { id: "booking-section", class: "max-w-6xl mx-auto p-4 py-12 flex flex-col md:flex-row gap-8" }, [
            (State.currentView === "public" || State.currentView === "booking") &&
            m("aside", { class: "w-full md:w-80 flex-shrink-0" }, [
              m(Calendar),
              State.isLogged &&
              m("div", {
                class: "p-6 rounded-[32px] mb-6 shadow-xl bg-slate-900 border border-slate-800 transition-all"
              }, [
                m("p", { class: "text-[9px] font-black text-green-500 uppercase tracking-widest mb-3" }, "Unirse con CÃ³digo"),
                m("div", { class: "flex gap-2" }, [
                  m("input", {
                    class: "flex-1 bg-white/10 border border-white/10 rounded-xl px-4 py-2 text-white text-xs font-bold focus:outline-none focus:border-green-500 uppercase transition-all",
                    placeholder: "CÃ“DIGO",
                    value: State.inviteInput,
                    oninput: (e) => (State.inviteInput = e.target.value),
                  }),
                  m("button", {
                    class: "bg-green-500 p-2 rounded-xl text-slate-900 hover:bg-green-400 transition",
                    onclick: Actions.joinByCode
                  }, "â†’"),
                ]),
              ]),
              m("p", { class: "text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 pl-1" }, "Seleccionar Hora"),
              m("div", { class: "grid grid-cols-4 gap-2" },
                HOURS.map((h) =>
                  m("button", {
                    class: `py-3 rounded-2xl text-[10px] font-bold border transition-all ${State.selectedTime === h
                        ? "bg-green-500 text-slate-900 border-green-500 shadow-xl shadow-green-500/20 scale-105 z-10"
                        : ThemeState.darkMode
                          ? "bg-slate-800 text-slate-400 border-slate-700 hover:border-green-500"
                          : "bg-white text-slate-500 border-slate-100 hover:border-green-200"
                      }`,
                    onclick: () => (State.selectedTime = h),
                  }, h)
                )
              ),
            ]),
            State.currentView === "public" || State.currentView === "booking"
              ? m("section", { class: "flex-1" }, [
                m("div", { class: "flex items-center justify-between mb-8" }, [
                  m("div", { class: "flex items-center gap-4" }, [
                    m("div", { class: "w-1 h-8 bg-green-500 rounded-full" }),
                    m("div", [
                      m("h2", { class: `text-2xl font-black tracking-tight ${ThemeState.darkMode ? "text-white" : "text-slate-800"}` }, `Pistas Disponibles`),
                      m("p", { class: "text-[10px] text-slate-400 font-bold uppercase" }, `Viendo resultados para el ${State.selectedDate}`),
                    ]),
                  ]),
                  m("span", {
                    class: `text-[10px] font-black px-3 py-1.5 rounded-full transition-colors ${ThemeState.darkMode ? "text-green-400 bg-green-500/10" : "text-green-500 bg-green-50"
                      }`
                  }, `${State.selectedTime}H`),
                ]),
                m(CourtGrid),
              ])
              : State.currentView === "matchmaking"
                ? m(MatchmakingView)
                : m(AgendaView),
          ]),
          m(BookingModal),
          m(Footer),
          m(ConfirmModal),
          m("div", {
            class: `fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl text-xs font-bold shadow-2xl transition-all z-[200] ${State.toast.show ? "translate-y-0 opacity-100" : "translate-y-24 opacity-0"}`,
          }, State.toast.message),
          State.isTerminatingSession &&
          m("div", {
            class: `fixed inset-0 z-[250] flex flex-col items-center justify-center animate-fade-up backdrop-blur-md ${ThemeState.darkMode ? "bg-slate-950/80" : "bg-white/80"
              }`
          }, [
            m("div", { class: `w-12 h-12 border-4 rounded-full animate-spin mb-4 ${ThemeState.darkMode ? "border-slate-800 border-t-green-500" : "border-slate-200 border-t-green-500"}` }),
            m("p", { class: `font-black text-sm tracking-widest uppercase ${ThemeState.darkMode ? "text-white" : "text-slate-800"}` }, "Cerrando sesiÃ³n..."),
          ]),
        ]),
    };

    m.mount(document.getElementById("app"), {
      oninit: Actions.checkSession,
      view: () => m("div", { class: ThemeActions.getMainClasses() }, [
        m(MainLayout)
      ]
      ),
    });

    window.addEventListener("click", () => {
      if (State.showUserMenu) {
        State.showUserMenu = false;
        m.redraw();
      }
    });
  </script>
</body>

</html>