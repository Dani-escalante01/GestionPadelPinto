<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Padel Pinto - Mi Perfil</title>
    <script src="https://unpkg.com/mithril/mithril.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%2322c55e'/><text x='50%' y='50%' font-family='sans-serif' font-weight='900' font-style='italic' font-size='60' fill='white' text-anchor='middle' dominant-baseline='central'>P</text></svg>" />
    <style>
        body {
            font-family: "Plus Jakarta Sans", sans-serif;
            background-color: #f8fafc;
        }

        .profile-gradient {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        #citizen-card {
            width: 400px;
            height: 220px;
            position: relative;
            overflow: hidden;
        }

        /* Estilo para que el logo del ayuntamiento se vea bien sobre fondo oscuro */
        .logo-ayto {
            filter: brightness(0) invert(1);
            max-height: 45px;
            width: auto;
        }
    </style>
</head>

<body>
    <div id="app"></div>

    <script>
        const State = {
            isEditing: false,
            user: {
                nombre: "Carlos",
                apellidos: "Pérez García",
                email: "carlos.perez@gmail.com",
                nivel: "Intermedio",
                partidas: 124,
                victorias: 82,
                foto: "https://media.licdn.com/dms/image/v2/D4D03AQEOP6WWeuAT4Q/profile-displayphoto-crop_800_800/B4DZowOnToGwAI-/0/1761745729736?e=1772064000&v=beta&t=x671SPTKjj55Pfb5XihA9X-Vb7eW5BlhVhA5841ntJI",
            },
            tempUser: {},
            downloading: false,
        };

        const Actions = {
            toggleEdit: () => {
                if (!State.isEditing) State.tempUser = { ...State.user };
                State.isEditing = !State.isEditing;
            },
            saveProfile: () => {
                const camposVacios = !State.tempUser.nombre.trim() ||
                    !State.tempUser.apellidos.trim() ||
                    !State.tempUser.email.trim();

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const emailInvalido = !emailRegex.test(State.tempUser.email);

                if (camposVacios) {
                    alert("Por favor, rellene todos los campos obligatorios");
                    return;
                }

                if (emailInvalido) {
                    alert("Por favor, introduzca un correo electrónico válido");
                    return;
                }

                State.user = { ...State.tempUser };
                State.isEditing = false;
            },
            handleFileUpload: (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        State.tempUser.foto = event.target.result;
                        m.redraw();
                    };
                    reader.readAsDataURL(file);
                }
            }
        };

        const downloadCard = () => {
            State.downloading = true;
            const card = document.getElementById("citizen-card");
            html2canvas(card, { useCORS: true, scale: 2, backgroundColor: null }).then((canvas) => {
                const link = document.createElement("a");
                link.download = `Tarjeta_${State.user.nombre}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                State.downloading = false;
                m.redraw();
            });
        };

        const Navbar = {
            view: () => m("nav", { class: "bg-white border-b sticky top-0 z-50 px-6 py-4" }, [
                m("div", { class: "max-w-5xl mx-auto flex justify-between items-center" }, [
                    m("div", { class: "flex items-center gap-2 cursor-pointer", onclick: () => (window.location.href = "index.html") }, [
                        m("div", { class: "w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center text-white font-black" }, "P"),
                        m("span", { class: "font-black text-slate-800" }, "PADELPINTO"),
                    ]),
                    m("button", { class: "text-xs font-bold text-slate-500 hover:text-green-600 transition", onclick: () => (window.location.href = "index.html") }, "← Volver a Reservas"),
                ]),
            ]),
        };

        const CitizenCardPreview = {
            view: () => m("div", { class: "mt-10" }, [
                m("h3", { class: "text-sm font-black text-slate-800 uppercase tracking-wider mb-4" }, "Tu Tarjeta Digital"),
                m("div", { id: "citizen-card", class: "profile-gradient rounded-3xl p-6 text-white shadow-2xl mb-4 flex flex-col justify-between" }, [
                    // Fila superior: Foto y Logo Ayuntamiento
                    m("div", { class: "flex justify-between items-start w-full" }, [
                        m("img", {
                            src: State.user.foto,
                            class: "w-16 h-16 rounded-2xl border-2 border-green-500 bg-white shadow-lg object-cover",
                            onerror: (e) => e.target.src = "https://api.dicebear.com/7.x/initials/svg?seed=CP&backgroundColor=2ecc71&textColor=0f172a"
                        }),
                        m("div", { class: "p-2.5 rounded-xl shadow-inner" }, [
                            m("img", {
                                src: "src/logo_escudo_pinto.png",
                                style: "max-height: 45px; width: auto; display: block;"
                            })
                        ])
                    ]),

                    // Fila inferior: Datos usuario
                    m("div", [
                        m("p", { class: "text-[10px] uppercase tracking-[0.2em] text-slate-400 font-bold" }, "Miembro Oficial"),
                        m("h2", { class: "text-xl font-extrabold" }, State.user.nombre),
                        m("h2", { class: "text-xl font-extrabold -mt-1" }, State.user.apellidos),
                    ]),
                ]),
                m("button", {
                    class: `w-full md:w-auto px-8 py-3 rounded-2xl text-xs font-bold transition flex items-center justify-center gap-2 ${State.downloading ? "bg-slate-400" : "bg-green-500 hover:bg-green-600 text-slate-900"}`,
                    onclick: downloadCard,
                    disabled: State.downloading,
                }, [State.downloading ? "Generando..." : "Descargar Tarjeta PNG"]),
            ]),
        };

        const ProfileCard = {
            view: () => m("div", { class: "max-w-5xl mx-auto p-6" }, [
                m("div", { class: "bg-white rounded-[40px] shadow-sm border border-slate-100 overflow-hidden" }, [
                    m("div", { class: "h-40 profile-gradient" }),

                    m("div", { class: "px-8 pb-8" }, [
                        m("div", { class: "flex flex-col md:flex-row items-end gap-6 -mt-16 mb-8" }, [
                            m("div", { class: "relative group" }, [
                                m("img", {
                                    src: State.isEditing ? State.tempUser.foto : State.user.foto,
                                    class: "w-32 h-32 rounded-[32px] border-8 border-white shadow-xl object-cover bg-white",
                                    onerror: (e) => e.target.src = "https://api.dicebear.com/7.x/initials/svg?seed=CP&backgroundColor=2ecc71&textColor=0f172a"
                                }),
                                State.isEditing && m("label", {
                                    class: "absolute inset-0 flex items-center justify-center bg-black/40 rounded-[32px] cursor-pointer text-white text-[10px] font-bold opacity-0 group-hover:opacity-100 transition-opacity"
                                }, [
                                    "SUBIR FOTO",
                                    m("input", { type: "file", class: "hidden", accept: "image/*", onchange: Actions.handleFileUpload })
                                ])
                            ]),

                            m("div", { class: "flex-1 mb-2", style: "margin-top: 5rem;" }, [
                                m("h1", { class: "text-3xl font-black text-slate-800" }, State.user.nombre + " " + State.user.apellidos),
                                m("p", { class: "text-sm font-bold text-slate-400 uppercase tracking-widest" }, "Nivel " + State.user.nivel),
                            ]),

                            !State.isEditing && m("button", {
                                class: "bg-slate-900 text-white px-6 py-3 rounded-2xl text-xs font-bold transition mb-2 hover:bg-slate-800",
                                onclick: Actions.toggleEdit
                            }, "✎ Editar Perfil"),
                        ]),

                        m("div", { class: "grid grid-cols-1 md:grid-cols-3 gap-12" }, [
                            m("div", { class: "md:col-span-2" }, [
                                m("h3", { class: "text-sm font-black text-slate-800 uppercase tracking-wider mb-6" }, "Detalles de la cuenta"),

                                m("div", { class: "grid grid-cols-1 md:grid-cols-2 gap-4" }, [
                                    State.isEditing && m("div", { class: "p-4 bg-white rounded-2xl border-2 border-green-500 md:col-span-2 shadow-sm" }, [
                                        m("p", { class: "text-[10px] font-black text-green-600 uppercase mb-1" }, "Link de foto externa (URL)"),
                                        m("input", {
                                            class: "bg-transparent text-sm font-bold text-slate-700 w-full outline-none",
                                            placeholder: "Pegue aquí el enlace de su foto...",
                                            value: State.tempUser.foto.startsWith('data:') ? '' : State.tempUser.foto,
                                            oninput: (e) => State.tempUser.foto = e.target.value
                                        }),
                                    ]),

                                    m("div", {
                                        class: "p-4 bg-slate-50 rounded-2xl border-2 transition " +
                                            (State.isEditing ? (State.tempUser.nombre.trim() === "" ? "border-red-500 bg-red-50" : "border-green-200 bg-white") : "border-transparent")
                                    }, [
                                        m("p", { class: "text-[10px] font-black text-slate-400 uppercase mb-1" }, "Nombre"),
                                        State.isEditing
                                            ? m("input", { class: "bg-transparent text-sm font-bold text-slate-700 w-full outline-none", value: State.tempUser.nombre, oninput: (e) => State.tempUser.nombre = e.target.value })
                                            : m("p", { class: "text-sm font-bold text-slate-700" }, State.user.nombre),
                                    ]),

                                    m("div", {
                                        class: "p-4 bg-slate-50 rounded-2xl border-2 transition " +
                                            (State.isEditing ? (State.tempUser.apellidos.trim() === "" ? "border-red-500 bg-red-50" : "border-green-200 bg-white") : "border-transparent")
                                    }, [
                                        m("p", { class: "text-[10px] font-black text-slate-400 uppercase mb-1" }, "Apellidos"),
                                        State.isEditing
                                            ? m("input", { class: "bg-transparent text-sm font-bold text-slate-700 w-full outline-none", value: State.tempUser.apellidos, oninput: (e) => State.tempUser.apellidos = e.target.value })
                                            : m("p", { class: "text-sm font-bold text-slate-700" }, State.user.apellidos),
                                    ]),

                                    m("div", {
                                        class: "p-4 bg-slate-50 rounded-2xl md:col-span-2 border-2 transition " +
                                            (State.isEditing ? (State.tempUser.email.trim() === "" ? "border-red-500 bg-red-50" : "border-green-200 bg-white") : "border-transparent")
                                    }, [
                                        m("p", { class: "text-[10px] font-black text-slate-400 uppercase mb-1" }, "Email"),
                                        State.isEditing
                                            ? m("input", { class: "bg-transparent text-sm font-bold text-slate-700 w-full outline-none", value: State.tempUser.email, oninput: (e) => State.tempUser.email = e.target.value })
                                            : m("p", { class: "text-sm font-bold text-slate-700" }, State.user.email),
                                    ]),

                                    m("div", {
                                        class: "p-4 bg-slate-50 rounded-2xl md:col-span-2 border-2 transition " +
                                            (State.isEditing ? "border-green-200 bg-white" : "border-transparent")
                                    }, [
                                        m("p", { class: "text-[10px] font-black text-slate-400 uppercase mb-1" }, "Nivel de Habilidad"),
                                        State.isEditing
                                            ? m("select", {
                                                class: "bg-transparent text-sm font-bold text-slate-700 w-full outline-none cursor-pointer",
                                                onchange: (e) => State.tempUser.nivel = e.target.value,
                                                value: State.tempUser.nivel
                                            }, [
                                                m("option", { value: "Principiante" }, "Principiante"),
                                                m("option", { value: "Iniciación" }, "Iniciación"),
                                                m("option", { value: "Intermedio" }, "Intermedio"),
                                                m("option", { value: "Avanzado" }, "Avanzado"),
                                                m("option", { value: "Pro" }, "Pro"),
                                            ])
                                            : m("p", { class: "text-sm font-bold text-slate-700" }, State.user.nivel),
                                    ]),
                                ]),

                                State.isEditing && m("div", { class: "mt-6 flex gap-3" }, [
                                    m("button", {
                                        class: "bg-green-500 text-slate-900 px-8 py-4 rounded-2xl text-sm font-black shadow-lg hover:bg-green-400 transition transform active:scale-95",
                                        onclick: Actions.saveProfile
                                    }, "✓ Guardar cambios"),
                                    m("button", {
                                        class: "bg-slate-200 text-slate-600 px-6 py-4 rounded-2xl text-sm font-bold hover:bg-slate-300 transition",
                                        onclick: () => State.isEditing = false
                                    }, "Cancelar")
                                ]),

                                m(CitizenCardPreview),
                            ]),

                            m("div", { class: "space-y-6" }, [
                                m("h3", { class: "text-sm font-black text-slate-800 uppercase tracking-wider" }, "Estadísticas"),
                                m("div", { class: "bg-green-500 p-6 rounded-[32px] text-slate-900 shadow-xl shadow-green-100" }, [
                                    m("div", { class: "flex justify-between items-center mb-4" }, [
                                        m("span", { class: "text-[10px] font-black uppercase" }, "Victorias"),
                                        m("span", { class: "text-2xl font-black" }, State.user.victorias),
                                    ]),
                                    m("div", { class: "w-full bg-white/30 h-2 rounded-full mb-2" }, [
                                        m("div", { class: "bg-white h-full rounded-full", style: "width: " + (State.user.victorias / State.user.partidas) * 100 + "%" }),
                                    ]),
                                    m("p", { class: "text-[10px] font-bold" }, State.user.partidas + " partidas jugadas"),
                                ]),
                            ]),
                        ]),
                    ]),
                ]),
            ]),
        };

        m.mount(document.getElementById("app"), {
            view: () => m("div", [m(Navbar), m(ProfileCard)]),
        });
    </script>
</body>

</html>