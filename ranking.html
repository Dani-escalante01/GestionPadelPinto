<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking - Padel Pinto</title>
    
    <script src="https://unpkg.com/mithril/mithril.js"></script>
    
    <script src="api.js"></script>
    <script src="toggleTheme.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. VARIABLES (Coherencia Visual) --- */
        :root {
            --primary: #22c55e;
            --primary-dark: #16a34a;
            --dark-bg: #0f172a;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --radius: 24px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            
            /* Colores de Podio */
            --gold: #fbbf24;
            --silver: #94a3b8;
            --bronze: #b45309;
        }

        .dark body { background-color: #0f172a; color: #f8fafc; }
        .dark .navbar, .dark .rank-card, .dark .podium-card { background-color: #1e293b; border-color: #334155; }
        .dark .rank-pos { background: #334155; color: white; }
        .dark .rank-header { background: #1e293b; border-bottom-color: #334155; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
            color: var(--text-main);
        }

        /* --- NAVBAR (Reutilizable) --- */
        .navbar {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }
        
        .nav-container { display: flex; justify-content: space-between; align-items: center; }
        
        .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 20px; text-decoration: none; color: inherit; }
        .logo-icon { background: var(--primary); color: white; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }

        .nav-links a { margin-left: 20px; text-decoration: none; color: var(--text-muted); font-weight: 700; font-size: 14px; text-transform: uppercase; }
        .nav-links a.active { color: var(--primary); }

        /* --- PODIO (Top 3) --- */
        .podium-section {
            padding: 40px 20px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            margin-bottom: 20px;
        }

        .podium-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
            width: 100%;
            max-width: 220px;
            transition: transform 0.3s;
        }

        /* Alturas escalonadas */
        .podium-1 { order: 2; transform: scale(1.1); z-index: 10; border-color: var(--gold); border-width: 2px; }
        .podium-2 { order: 1; margin-bottom: -20px; }
        .podium-3 { order: 3; margin-bottom: -40px; }

        .medal-icon {
            font-size: 24px;
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 50%;
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .avatar-large {
            width: 80px; height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 10px auto;
            border: 4px solid var(--border);
        }
        .podium-1 .avatar-large { border-color: var(--gold); }
        .podium-2 .avatar-large { border-color: var(--silver); }
        .podium-3 .avatar-large { border-color: var(--bronze); }

        .player-name { font-weight: 800; font-size: 1.1rem; margin: 5px 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .player-level { font-weight: 700; color: var(--primary); font-size: 0.9rem; }
        .player-stats { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; font-weight: 600; }

        /* --- LISTA (Resto) --- */
        .ranking-list {
            max-width: 800px;
            margin: 0 auto 60px auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rank-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.2s;
        }

        .rank-card:hover { transform: translateX(5px); border-color: var(--primary); }

        .rank-pos {
            font-size: 14px; font-weight: 900;
            width: 30px; height: 30px;
            background: var(--border);
            color: var(--text-muted);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
        }

        .rank-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .rank-info { flex: 1; }
        .rank-name { font-weight: 700; font-size: 14px; }
        .rank-detail { font-size: 11px; color: var(--text-muted); }

        .rank-score { text-align: right; }
        .score-val { font-size: 16px; font-weight: 900; color: var(--primary); }
        .score-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; }

        @media (max-width: 768px) {
            .podium-section { flex-direction: column; align-items: center; gap: 30px; margin-top: 30px; }
            .podium-1, .podium-2, .podium-3 { order: unset; margin-bottom: 0; transform: none; width: 100%; }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // --- ESTADO ---
        const State = {
            loading: true,
            ranking: [] // Inicializado como array vacÃ­o para seguridad
        };

        // --- ACCIONES ---
        const Actions = {
            init: async () => {
                Auth.init();
                await Actions.loadData();
            },

            loadData: async () => {
                State.loading = true;
                try {
                    // Llamada segura a la API
                    const users = await PadelData.getRanking();
                    // Aseguramos que sea un array, si falla la API usamos []
                    State.ranking = Array.isArray(users) ? users : [];
                } catch (e) {
                    console.error("Error cargando ranking:", e);
                    State.ranking = [];
                } finally {
                    State.loading = false;
                    m.redraw();
                }
            }
        };

        // --- COMPONENTES ---

        function Navbar() {
            return {
                view: () => m("nav", { class: "navbar" }, [
                    m("div", { class: "container nav-container" }, [
                        m("a", { href: "index.html", class: "brand" }, [
                            m("div", { class: "logo-icon" }, "P"),
                            m("span", "PADELPINTO")
                        ]),
                        m("div", { class: "nav-links" }, [
                            m("a", { href: "index.html" }, "Reservar"),
                            m("a", { href: "partidas.html" }, "Partidas"),
                            m("a", { href: "#", class: "active" }, "Ranking"),
                            m(ThemeToggle)
                        ])
                    ])
                ])
            };
        }

        // Tarjeta para el Podio (Top 3)
        function PodiumCard() {
            return {
                view: (vnode) => {
                    const { user, place } = vnode.attrs;
                    if (!user) return null;

                    let medal = "ðŸ¥‡";
                    let cssClass = "podium-1";
                    if (place === 2) { medal = "ðŸ¥ˆ"; cssClass = "podium-2"; }
                    if (place === 3) { medal = "ðŸ¥‰"; cssClass = "podium-3"; }

                    // Usar nombre o iniciales si no hay foto
                    const avatarSrc = user.foto && user.foto.length > 10 
                        ? user.foto 
                        : `https://api.dicebear.com/7.x/initials/svg?seed=${user.nombre}`;

                    return m("div", { class: `podium-card ${cssClass} animate-fade-up` }, [
                        m("div", { class: "medal-icon" }, medal),
                        m("img", { 
                            class: "avatar-large", 
                            src: avatarSrc
                        }),
                        m("div", { class: "player-name" }, user.nombre),
                        m("div", { class: "player-level" }, `Nivel ${parseFloat(user.nivel).toFixed(2)}`),
                        m("div", { class: "player-stats" }, `${user.victorias}V - ${user.derrotas}D`)
                    ]);
                }
            };
        }

        // Fila para el resto de la lista (4Âº en adelante)
        function RankingRow() {
            return {
                view: (vnode) => {
                    const { user, pos } = vnode.attrs;
                    
                    const avatarSrc = user.foto && user.foto.length > 10 
                        ? user.foto 
                        : `https://api.dicebear.com/7.x/initials/svg?seed=${user.nombre}`;

                    return m("div", { class: "rank-card animate-fade-up", style: `animation-delay: ${pos * 0.05}s` }, [
                        m("div", { class: "rank-pos" }, pos),
                        m("img", { 
                            class: "rank-avatar", 
                            src: avatarSrc
                        }),
                        m("div", { class: "rank-info" }, [
                            m("div", { class: "rank-name" }, user.nombre),
                            m("div", { class: "rank-detail" }, `${user.victorias} Victorias â€¢ ${user.derrotas} Derrotas`)
                        ]),
                        m("div", { class: "rank-score" }, [
                            m("div", { class: "score-val" }, parseFloat(user.nivel).toFixed(2)),
                            m("div", { class: "score-label" }, "Nivel")
                        ])
                    ]);
                }
            };
        }

        // --- VISTA PRINCIPAL ---
        function RankingView() {
            return {
                view: () => {
                    // PROTECCIÃ“N: Aseguramos que State.ranking sea un array antes de usar slice
                    const safeRanking = Array.isArray(State.ranking) ? State.ranking : [];
                    const top3 = safeRanking.slice(0, 3);
                    const rest = safeRanking.slice(3);

                    return m("div", [
                        m(Navbar),
                        m("div", { class: "container" }, [
                            
                            State.loading 
                            ? m("div", { style: "text-align:center; padding:50px; color:#94a3b8;" }, "Calculando posiciones...")
                            : [
                                // SECCIÃ“N PODIO
                                m("div", { class: "podium-section" }, [
                                    top3[1] ? m(PodiumCard, { user: top3[1], place: 2 }) : null,
                                    top3[0] ? m(PodiumCard, { user: top3[0], place: 1 }) : null,
                                    top3[2] ? m(PodiumCard, { user: top3[2], place: 3 }) : null,
                                ]),

                                // SECCIÃ“N LISTA
                                m("div", { class: "ranking-list" }, [
                                    rest.length > 0 
                                    ? [
                                        m("h3", { style: "margin-bottom:20px; opacity:0.6; font-size:14px; text-transform:uppercase; letter-spacing:1px;" }, "Resto de Jugadores"),
                                        rest.map((user, idx) => m(RankingRow, { user, pos: idx + 4 }))
                                      ]
                                    : m("div", { style:"text-align:center; color:#94a3b8; padding:20px" }, "No hay mÃ¡s jugadores clasificados.")
                                ])
                            ]
                        ])
                    ]);
                }
            };
        }

        // --- INIT ---
        m.mount(document.getElementById("app"), {
            oninit: Actions.init,
            view: () => m(RankingView)
        });

    </script>
</body>
</html>